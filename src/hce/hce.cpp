#include "../pos.h"
#include "hce.h"

const Eval psqt_early[6][64] = {
    {
        0,  0,  0,  0,  0,  0,  0,  0,
       70, 70, 70, 70, 70, 70, 70, 70,
       50, 50, 50, 50, 50, 50, 50, 50,
       10, 10, 30, 30, 30, 10, 10, 10,
        0,  0, 15, 15, 15, 15,  0,  0,
        0,  0,  7,  7,  7,  7,  0,  0,
        0,  0,  0,  0,  0, 20,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
    },
    {
      -10,-10,-10,-10,-10,-10,-10,-10,
       10, 10, 10, 10, 10, 10, 10, 10,
       20, 50, 50, 50, 50, 50, 50, 20,
       10, 10, 20, 30, 30, 20, 10, 10,
      -30,  0, 15, 20, 20, 15,  0,-30,
      -30,  0, 10, 15, 15, 10,  0,-30,
      -40,-20,  0,  0,  0,  0,-20,-40,
      -40,-20,-20,-20,-20,-20,-20,-40,
    },
    {
       20,  0,  0,  0,  0,  0,  0, 20,
        0, 30, 10, 10, 10, 10, 30,  0,
        0, 10, 40, 10, 10, 40, 10,  0,
        0, 10, 10, 50, 50, 10, 10,  0,
        0, 10, 10, 50, 50, 10, 10,  0,
        0, 10, 40, 10, 10, 40, 10,  0,
        0, 30, 10, 10, 10, 10, 30,  0,
       20,  0,  0,  0,  0,  0,  0, 20,
    },
    {
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0, 10, 10, 10, 10, 10, 10,  0,
    },
    {
        20,  0,  0,  0,  0,  0,  0, 20,
         0, 30, 10, 10, 10, 10, 30,  0,
         0, 10, 40, 10, 10, 40, 10,  0,
         0, 10, 10, 50, 50, 10, 10,  0,
         0, 10, 10, 50, 50, 10, 10,  0,
         0, 10, 40, 10, 10, 40, 10,  0,
         0, 30, 10, 10, 10, 10, 30,  0,
        20,  0,  0,  0,  0,  0,  0, 20,
    },
    {
        -50,-50,-50,-50,-50,-50,-50,-50,
        -50,-50,-50,-50,-50,-50,-50,-50,
        -50,-50,-50,-50,-50,-50,-50,-50,
        -50,-50,-50,-50,-50,-50,-50,-50,
        -50,-50,-50,-50,-50,-50,-50,-50,
        -10,-20,-20,-20,-20,-20,-20,-10,
         20, 20,  0,  0,  0,  0, 20, 20,
         30, 30,  0,-20,-20,  0, 30, 30,
    },
};

const Eval psqt_late[6][64] = {
    {
        0,  0,  0,  0,  0,  0,  0,  0,
       70, 70, 70, 70, 70, 70, 70, 70,
       50, 50, 50, 50, 50, 50, 50, 50,
       10, 10, 30, 30, 30, 10, 10, 10,
        0,  0, 15, 15, 15, 15,  0,  0,
        0,  0,  7,  7,  7,  7,  0,  0,
        0,  0,  0,  0,  0, 20,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
    },
    {
      -10,-10,-10,-10,-10,-10,-10,-10,
       10, 10, 10, 10, 10, 10, 10, 10,
       20, 50, 50, 50, 50, 50, 50, 20,
       10, 10, 20, 30, 30, 20, 10, 10,
      -30,  0, 15, 20, 20, 15,  0,-30,
      -30,  0, 10, 15, 15, 10,  0,-30,
      -40,-20,  0,  0,  0,  0,-20,-40,
      -40,-20,-20,-20,-20,-20,-20,-40,
    },
    {
       20,  0,  0,  0,  0,  0,  0, 20,
        0, 30, 10, 10, 10, 10, 30,  0,
        0, 10, 40, 10, 10, 40, 10,  0,
        0, 10, 10, 50, 50, 10, 10,  0,
        0, 10, 10, 50, 50, 10, 10,  0,
        0, 10, 40, 10, 10, 40, 10,  0,
        0, 30, 10, 10, 10, 10, 30,  0,
       20,  0,  0,  0,  0,  0,  0, 20,
    },
    {
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0,  0,  0,  0,  0,  0,  0,  0,
        0, 10, 10, 10, 10, 10, 10,  0,
    },
    {
        20,  0,  0,  0,  0,  0,  0, 20,
         0, 30, 10, 10, 10, 10, 30,  0,
         0, 10, 40, 10, 10, 40, 10,  0,
         0, 10, 10, 50, 50, 10, 10,  0,
         0, 10, 10, 50, 50, 10, 10,  0,
         0, 10, 40, 10, 10, 40, 10,  0,
         0, 30, 10, 10, 10, 10, 30,  0,
        20,  0,  0,  0,  0,  0,  0, 20,
    },
    {
        -10,-10,-10,-10,-10,-10,-10,-10,
        -10,  0,  0,  0,  0,  0,  0,-10,
        -10,  0,  0,  0,  0,  0,  0,-10,
        -10,  0,  0,  0,  0,  0,  0,-10,
        -10,  0,  0,  0,  0,  0,  0,-10,
        -10,  0,  0,  0,  0,  0,  0,-10,
        -10,  0,  0,  0,  0,  0,  0,-10,
        -10,-10,-10,-10,-10,-10,-10,-10,
    },
};
    
Eval evaluate_side(const Pos& pos, const Color side, float phase) {
    Eval eval = bb_count(pos.pieces(side, PAWN))   * 100
              + bb_count(pos.pieces(side, KNIGHT)) * 280
              + bb_count(pos.pieces(side, BISHOP)) * 300
              + bb_count(pos.pieces(side, ROOK))   * 500
              + bb_count(pos.pieces(side, QUEEN))  * 900;

    Eval eval_early = 0;
    Eval eval_late = 0;

    for (Piece piece = PAWN; piece <= KING; piece++) {

        BB squares = pos.pieces(side, piece);

        while (squares) {
            Square square = flip_components(bb_pop(squares), side == WHITE, false);
            eval_early += psqt_early[piece][square];
            eval_late  += psqt_late [piece][square];
        }

    }

    eval += Eval(eval_early * (1 - phase) + eval_late * phase);

    return eval;
}

float get_phase(const Pos& pos) {
    return float(bb_count(pos.pieces(KNIGHT)) * 3
               + bb_count(pos.pieces(BISHOP)) * 5
               + bb_count(pos.pieces(ROOK))   * 10
               + bb_count(pos.pieces(QUEEN))  * 20) / 112.0f;
}

Eval Evaluator::evaluate(const Pos& pos) {
    float phase = get_phase(pos);
    return evaluate_side(pos, pos.turn(), phase) - evaluate_side(pos, pos.notturn(), phase);
}